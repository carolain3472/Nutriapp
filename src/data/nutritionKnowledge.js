// Base de conocimientos nutricionales ampliada y mejorada
export const nutritionKnowledge = {
    // Respuestas por categorías principales
    greetings: [
      "¡Hey! Soy tu asistente nutricional personal. ¿En qué te puedo echar una mano hoy? Puedo ayudarte con planes de comida, recetas, dudas sobre nutrición o lo que necesites.",
      "¡Hola! Me da mucho gusto verte por aquí. Estoy listo para ayudarte con todo lo relacionado a nutrición y alimentación saludable. ¿Qué tienes en mente?",
      "¡Qué tal! Soy tu compañero nutricional. Ya sea que quieras mejorar tu alimentación, aprender sobre nutrición o necesites ideas para comidas, aquí estoy para apoyarte.",
      "¡Hola! Perfecto timing para hablar de nutrición. ¿Hay algo específico que te tiene pensando sobre tu alimentación hoy?"
    ],
  
    // Respuestas empáticas para diferentes estados emocionales
    emotional: {
      frustrated: [
        "Oye, entiendo perfectamente esa frustración. La nutrición puede ser confusa con tanta información contradictoria por ahí. Vamos paso a paso, sin presión. ¿Qué es lo que más te está costando trabajo en este momento?",
        "Sé que puede ser súper frustrante cuando sientes que estás haciendo todo 'bien' pero no ves resultados. Cada cuerpo es diferente y tiene sus propios tiempos. ¿Me cuentas qué has estado intentando?",
        "La frustración es totalmente normal en este proceso. A veces necesitamos ajustar la estrategia, no abandonarla. ¿Qué tal si revisamos juntos qué está pasando?"
      ],
      motivated: [
        "¡Me encanta esa energía! Cuando tienes esa motivación es el momento perfecto para establecer hábitos que realmente perduren. ¿Cuál es tu objetivo principal?",
        "¡Eso es lo que me gusta escuchar! Aprovechemos esa motivación para crear un plan que sea sostenible y que realmente disfrutes. ¿Por dónde quieres empezar?",
        "¡Qué buena actitud! Es genial cuando decides priorizar tu salud. Vamos a canalizar esa energía hacia cambios que puedas mantener a largo plazo."
      ],
      confused: [
        "Tranquilo, es súper normal sentirse abrumado con tanta información nutricional. Vamos a simplificar las cosas y empezar por lo básico. ¿Qué es lo que más te confunde?",
        "No te preocupes, todos hemos estado ahí. La nutrición no tiene que ser complicada. Te voy a explicar todo de manera sencilla. ¿Sobre qué tema específico tienes dudas?",
        "Entiendo esa confusión, hay mucha información contradictoria. Vamos a aclarar las cosas de una vez por todas. ¿Cuál es tu duda principal?"
      ],
      anxious: [
        "Respira hondo. La ansiedad alrededor de la comida es más común de lo que piensas. No hay alimentos 'prohibidos' ni decisiones perfectas. ¿Qué es lo que más te preocupa?",
        "Hey, todo va a estar bien. La alimentación saludable no tiene que generar estrés. Vamos a encontrar un enfoque que te haga sentir tranquilo y en control.",
        "Entiendo esa ansiedad. A veces la presión de comer 'perfecto' puede ser abrumadora. Vamos a trabajar en un enfoque más relajado y sostenible."
      ]
    },
  
    // Respuestas expandidas para pérdida de peso
    weightLoss: {
      general: [
        "Para perder peso de manera inteligente y sostenible, lo clave es crear un déficit calórico moderado sin morir de hambre. Te recomiendo:\n\n• Déficit de 300-500 calorías diarias (nada extremo)\n• Proteína en cada comida para mantener músculo\n• Muchas verduras para saciedad\n• Carbohidratos complejos para energía\n• Hidratación constante\n\n¿Cuál dirías que es tu mayor desafío al intentar perder peso?",
        "La pérdida de peso que realmente funciona a largo plazo no es sobre restricción extrema, sino sobre crear hábitos que puedas mantener. Algunos tips que funcionan:\n\n• Come despacio y escucha a tu cuerpo\n• Llena la mitad del plato con verduras\n• Include proteína en cada comida\n• Mantén horarios regulares\n• Duerme bien (súper importante)\n\n¿Has intentado alguna dieta antes? ¿Qué tal te fue?"
      ],
      plateaus: [
        "Los estancamientos son súper normales y frustrantes, pero tienen solución. Tu cuerpo se adapta, así que necesitamos 'confundirlo' un poco:\n\n• Varía tu rutina de ejercicio\n• Ajusta ligeramente las calorías\n• Revisa si estás durmiendo bien\n• Considera hacer una semana de mantenimiento\n• Mide progreso más allá de la báscula\n\n¿Hace cuánto que no ves cambios en el peso?",
        "Los plateaus son la forma en que tu cuerpo dice 'necesito un descanso'. No significa que estés haciendo algo mal:\n\n• Tu metabolismo puede necesitar un reset\n• Tal vez estás ganando músculo mientras pierdes grasa\n• El estrés y el sueño influyen muchísimo\n• A veces necesitas comer un poco más, no menos\n\n¿Cómo te sientes de energía? ¿Has notado cambios en cómo te queda la ropa?"
      ],
      emotional: [
        "La comida emocional es súper común y entendible. Todos comemos por emociones a veces. Lo importante es desarrollar otras estrategias:\n\n• Identifica qué emociones te llevan a comer\n• Ten alternativas listas (caminar, llamar a alguien, etc.)\n• No te culpes cuando pase, aprende de la situación\n• Busca el patrón para prevenirlo\n\n¿Has notado qué situaciones o emociones te llevan más a comer?"
      ]
    },
  
    // Respuestas expandidas para ganar masa muscular
    muscleGain: {
      general: [
        "Para ganar músculo de manera efectiva necesitas tres pilares fundamentales:\n\n• Superávit calórico moderado (300-500 kcal extra)\n• Proteína suficiente: 1.6-2.2g por kg de peso\n• Entrenamiento de fuerza consistente\n• Descanso adecuado para recuperación\n\n¿Cuál es tu peso actual para calcular tus necesidades exactas?",
        "El crecimiento muscular es un proceso que requiere paciencia y consistencia. Lo bueno es que funciona si haces las cosas bien:\n\n• Come en superávit, pero no te pases\n• Distribuye la proteína a lo largo del día\n• Entrena cada grupo muscular 2-3 veces por semana\n• Duerme 7-9 horas para recuperación\n\n¿Estás entrenando con pesas actualmente?"
      ],
      hardgainer: [
        "Si te cuesta ganar peso, probablemente tienes un metabolismo rápido. Algunos tips específicos:\n\n• Come más frecuentemente (5-6 comidas)\n• Incluye más grasas saludables (más calorías por gramo)\n• Batidos de proteína con avena y mantequilla de maní\n• No llenes tanto con agua antes de comer\n• Prioriza alimentos densos en calorías\n\n¿Cuántas comidas haces al día actualmente?",
        "Para los 'hard gainers' el secreto está en maximizar cada comida:\n\n• Desayunos abundantes (avena con frutos secos)\n• Snacks calóricos entre comidas\n• Cenas consistentes aunque no tengas hambre\n• Batidos post-entreno con carbos y proteína\n• Paciencia, porque vas a ganar músculo de calidad\n\n¿Te cuesta trabajo sentir hambre o simplemente te llenas rápido?"
      ]
    },
  
    // Recetas organizadas por momento del día y objetivo
    recipes: {
      breakfast: {
        quick: [
          "**Smoothie Proteico Express** (5 min)\n\n• 1 plátano maduro\n• 1 scoop de proteína (vainilla)\n• 1 taza de leche de almendras\n• 1 cda de mantequilla de maní\n• Hielo\n\nLicúa todo y listo. Perfecto para prisa.\n~400 kcal, 30g proteína",
          "**Avena Overnight Deluxe** (prep la noche anterior)\n\n• 1/2 taza de avena\n• 1 taza de leche\n• 1 cda de chía\n• 1 cda de miel\n• Frutos del bosque\n\nMezcla todo antes de dormir. Por la mañana solo añade fruta fresca.\n~350 kcal, 15g proteína"
        ],
        hearty: [
          "**Tortilla de Espinacas y Queso** (15 min)\n\n• 3 huevos enteros\n• 2 tazas de espinacas baby\n• 1/4 taza de queso feta\n• 1 rebanada de pan integral\n• Aceite de oliva\n\nSaltea espinacas, añade huevos batidos, queso al final.\n~450 kcal, 32g proteína",
          "**Bowl de Yogur Griego Power** (10 min)\n\n• 1 taza de yogur griego natural\n• 1/3 taza de granola casera\n• 1 cda de miel\n• Frutos secos mixtos\n• Fruta de temporada\n\nUn desayuno que te mantiene lleno por horas.\n~380 kcal, 25g proteína"
        ]
      },
      lunch: {
        office: [
          "**Ensalada de Pollo Mediterránea** (prep dominical)\n\n• Pechuga de pollo grillada\n• Mix de hojas verdes\n• Tomates cherry, pepino\n• Aceitunas y queso feta\n• Vinagreta de limón\n\nPrepara todo el domingo y tienes lunch para toda la semana.\n~420 kcal, 35g proteína",
          "**Bowl de Quinoa y Salmón** (20 min)\n\n• 1 taza de quinoa cocida\n• 120g de salmón a la plancha\n• Aguacate en cubos\n• Edamames\n• Aderezo de tahini\n\nComida completa que te da energía para toda la tarde.\n~480 kcal, 32g proteína"
        ],
        home: [
          "**Pasta Integral con Pesto de Espinacas** (25 min)\n\n• 80g pasta integral\n• 2 tazas espinacas frescas\n• 1/4 taza de nueces\n• Ajo y aceite de oliva\n• Queso parmesano\n\nLicúa espinacas, nueces, ajo y aceite. Mezcla con pasta.\n~450 kcal, 18g proteína"
        ]
      },
      dinner: {
        light: [
          "**Sopa de Lentejas con Verduras** (30 min)\n\n• 1 taza de lentejas rojas\n• Apio, zanahoria, cebolla\n• Caldo de verduras\n• Especias al gusto\n• Un toque de limón\n\nComfort food saludable que no te deja pesado.\n~320 kcal, 18g proteína",
          "**Pescado al Horno con Verduras** (25 min)\n\n• Filete de pescado blanco\n• Calabacín, pimientos, cebolla\n• Aceite de oliva y hierbas\n• Limón\n\nTodo al horno en una bandeja. Fácil y nutritivo.\n~280 kcal, 28g proteína"
        ],
        satisfying: [
          "**Tacos de Pollo con Aguacate** (20 min)\n\n• Pechuga de pollo desmenuzada\n• Tortillas de maíz\n• Aguacate, tomate, cebolla\n• Salsa verde casera\n• Yogur griego como crema\n\nComida mexicana saludable que satisface antojos.\n~380 kcal, 30g proteína"
        ]
      },
      snacks: {
        sweet: [
          "**Energy Balls Caseras** (15 min prep)\n\n• 1 taza de dátiles sin hueso\n• 1/2 taza de almendras\n• 2 cdas de cacao\n• 1 cda de mantequilla de almendras\n\nProcesa todo, forma bolitas, refrigera.\n~80 kcal por bolita",
          "**Yogur con Granola Casera**\n\n• 3/4 taza yogur griego\n• 2 cdas granola sin azúcar\n• Frutos rojos\n• Un toque de miel\n\nDulce saludable que calma antojos.\n~180 kcal, 15g proteína"
        ],
        savory: [
          "**Hummus con Verduras**\n\n• 1/3 taza de hummus casero\n• Palitos de zanahoria, apio, pepino\n• Tomates cherry\n\nSnack que te llena y nutre.\n~120 kcal, 6g proteína",
          "**Tostada de Aguacate Deluxe**\n\n• 1 rebanada pan integral\n• 1/2 aguacate maduro\n• Tomate cherry\n• Semillas de hemp\n• Sal y limón\n\nClásico que nunca falla.\n~220 kcal, 8g proteína"
        ]
      }
    },
  
    // Información sobre horarios y timing
    mealTiming: {
      general: [
        "El timing de las comidas puede marcar diferencia, aunque no es lo más importante:\n\n• Desayuno: Dentro de 2 horas de despertar\n• Comidas cada 3-4 horas aproximadamente\n• Cena: 2-3 horas antes de dormir\n• Post-entreno: Proteína + carbos dentro de 2 horas\n\n¿Tienes horarios muy irregulares o bastante fijos?",
        "Los horarios ideales dependen mucho de tu rutina personal:\n\n• Lo más importante es la consistencia\n• Escucha las señales de hambre de tu cuerpo\n• Si entrenas, el timing post-workout sí importa\n• No te obsesiones con horarios exactos\n\n¿Cuál es tu horario típico de comidas actualmente?"
      ],
      workSchedule: [
        "Para horarios de oficina estándar te recomiendo:\n\n• 7-8am: Desayuno consistente\n• 10-11am: Snack si es necesario\n• 12-2pm: Almuerzo principal\n• 4-5pm: Snack/merienda\n• 7-8pm: Cena\n\n¿Tu trabajo te permite comer a horarios regulares?",
        "Si trabajas turnos irregulares:\n\n• Mantén al menos 3 comidas principales\n• Ten snacks saludables siempre a mano\n• Hidratación constante es clave\n• Trata de comer algo cada 4-5 horas máximo\n\n¿Qué tipo de horario manejas en tu trabajo?"
      ]
    },
  
    // Información sobre intolerancias y alergias
    intolerances: {
      lactose: [
        "La intolerancia a la lactosa no significa eliminar todo lácteo:\n\n• Yogur griego y quesos maduros suelen tolerarse mejor\n• Leches vegetales fortificadas (almendra, avena)\n• Lactasa en pastillas si quieres comer lácteos ocasionalmente\n• Muchos alimentos ricos en calcio sin lactosa\n\n¿Qué tan severa es tu intolerancia? ¿Puedes tolerar pequeñas cantidades?",
        "Alternativas ricas en calcio sin lactosa:\n\n• Almendras y tahini\n• Verduras de hoja verde oscura\n• Sardinas con hueso\n• Leches vegetales fortificadas\n• Tofu hecho con sulfato de calcio\n\n¿Te preocupa especialmente algún nutriente al evitar lácteos?"
      ],
      gluten: [
        "Vivir sin gluten es totalmente manejable hoy en día:\n\n• Céntrate en alimentos naturalmente sin gluten\n• Quinoa, arroz, avena certificada sin gluten\n• Lee etiquetas siempre (se esconde en muchos productos)\n• Evita contaminación cruzada si eres celíaco\n\n¿Es por celiaquía o sensibilidad al gluten?",
        "Granos y cereales seguros sin gluten:\n\n• Quinoa (súper versátil)\n• Arroz en todas sus variedades\n• Avena certificada sin gluten\n• Amaranto y mijo\n• Trigo sarraceno\n\n¿Hay algún grano específico que te guste más o quieras probar?"
      ]
    },
  
    // Respuestas sobre hidratación expandidas
    hydration: {
      general: [
        "La hidratación va mucho más allá de solo 'tomar 8 vasos':\n\n• Tu peso en kg x 35ml = necesidad base\n• Más si haces ejercicio o hace calor\n• El color de tu orina es el mejor indicador\n• Frutas y verduras también cuentan\n• Infusiones sin azúcar son perfectas\n\n¿Te cuesta trabajo tomar suficiente agua durante el día?",
        "Tips para hidratarte mejor sin aburrirte:\n\n• Agua con rodajas de pepino o limón\n• Tés de hierbas fríos\n• Agua con gas y un splash de jugo natural\n• Botella con marcas horarias\n• Apps recordatorias si eres olvidadizo\n\n¿Cuál dirías que es tu mayor obstáculo para hidratarte bien?"
      ],
      exercise: [
        "Para hidratación durante ejercicio:\n\n• Antes: 500ml, 2 horas antes\n• Durante: 150-250ml cada 15-20 min\n• Después: 150% del peso perdido en sudor\n• Electrolitos si ejercicio > 1 hora\n\n¿Qué tipo de ejercicio haces y por cuánto tiempo?"
      ]
    },
  
    // Manejo de respuestas incoherentes o sin sentido
    fallback: [
      "Hmm, no estoy seguro de haber entendido bien tu pregunta. ¿Podrías reformularla? Estoy aquí para ayudarte con todo lo relacionado a nutrición y alimentación saludable.",
      "Creo que hubo algo confuso en tu mensaje. ¿Te refieres a algo específico sobre nutrición, recetas, o hábitos alimenticios? Me encanta ayudar, solo necesito entender mejor qué buscas.",
      "No logré captar exactamente qué necesitas. ¿Estás preguntando sobre algún alimento en particular, recetas, planes de alimentación, o algún tema nutricional específico?",
      "Parece que tu mensaje se cortó o hubo algún error. Sin problema, vuelve a escribirme lo que necesitas saber sobre nutrición y con gusto te ayudo."
    ],
  
    // Respuestas motivacionales
    motivation: [
      "Los cambios reales toman tiempo, pero cada decisión saludable cuenta. No se trata de perfección, sino de progreso constante. ¿Qué pequeño cambio podrías hacer hoy?",
      "Recuerda que estás invirtiendo en tu salud a largo plazo. Cada comida nutritiva es un paso hacia la versión más saludable de ti mismo. ¡Vas por buen camino!",
      "No subestimes el poder de los hábitos pequeños y consistentes. No necesitas una transformación radical overnight. ¿Cuál sería un cambio pequeño que podrías mantener por una semana?",
      "Tu cuerpo es increíblemente inteligente y adaptable. Dale tiempo, nutrientes de calidad y movimiento, y verás resultados. La paciencia es tu mejor aliada en este proceso."
    ],
  
    // Respuestas sobre ejercicio y nutrición
    exercise: [
      "La nutrición y el ejercicio van de la mano:\n\n• Pre-entreno: Carbos 30-60 min antes\n• Post-entreno: Proteína + carbos dentro de 2 horas\n• Hidratación antes, durante y después\n• No hagas ejercicio en ayuno si eres principiante\n\n¿Qué tipo de ejercicio haces y cuándo prefieres entrenar?",
      "Para maximizar tus entrenamientos:\n\n• Come algo ligero si entrenas en ayunas\n• Proteína post-entreno para recuperación\n• Carbohidratos para reponer energía\n• Electrolitos si sudas mucho\n\n¿Tienes alguna meta específica con el ejercicio?"
    ],
  
    // Despedidas amigables
    goodbye: [
      "¡Fue un placer ayudarte! Espero que pongas en práctica estos consejos. Recuerda que los cambios pequeños y consistentes son los que realmente funcionan. ¡Nos vemos pronto!",
      "¡Excelente conversación! Me da mucho gusto poder apoyarte en tu journey nutricional. Ya sabes que aquí estaré cuando necesites más consejos o tengas dudas. ¡Cuídate mucho!",
      "Perfecto, espero haberte ayudado con tus dudas nutricionales. Recuerda ser paciente contigo mismo y celebrar cada progreso. ¡Que tengas un día delicioso y nutritivo!",
      "¡Qué bueno poder platicar contigo sobre nutrición! Aplica lo que conversamos a tu ritmo y sin presión. Estoy aquí cuando necesites más apoyo. ¡Hasta la próxima!"
    ]
  };
  
  // Sistema de categorización inteligente mejorado
  export const intelligentCategorizer = {
    // Detecta estado emocional en el mensaje
    detectEmotion: (message) => {
      const lowerMessage = message.toLowerCase();
      
      const frustrationWords = ['frustrado', 'frustrada', 'no funciona', 'cansado', 'cansada', 'harto', 'harta', 'desesperado', 'imposible'];
      const motivationWords = ['motivado', 'motivada', 'decidido', 'decidida', 'listo', 'lista', 'empezar', 'comenzar', 'meta'];
      const confusionWords = ['confundido', 'confundida', 'no entiendo', 'no sé', 'dudas', 'perdido', 'perdida'];
      const anxietyWords = ['preocupado', 'preocupada', 'ansiedad', 'miedo', 'nervioso', 'nerviosa', 'estrés'];
      
      if (frustrationWords.some(word => lowerMessage.includes(word))) return 'frustrated';
      if (motivationWords.some(word => lowerMessage.includes(word))) return 'motivated';
      if (confusionWords.some(word => lowerMessage.includes(word))) return 'confused';
      if (anxietyWords.some(word => lowerMessage.includes(word))) return 'anxious';
      
      return null;
    },
  
    // Detecta el tema principal del mensaje
    detectTopic: (message) => {
      const lowerMessage = message.toLowerCase();
      
      // Patrones para pérdida de peso
      if (/perder peso|adelgazar|bajar|dieta|quemar grasa|déficit/.test(lowerMessage)) {
        if (/estancado|plateau|no bajo|no pierdo/.test(lowerMessage)) return 'weightLoss.plateaus';
        if (/emocional|ansiedad|estrés|sentimientos/.test(lowerMessage)) return 'weightLoss.emotional';
        return 'weightLoss.general';
      }
      
      // Patrones para ganar peso/músculo
      if (/ganar peso|masa muscular|músculo|aumentar|bulking/.test(lowerMessage)) {
        if (/cuesta ganar|no gano|difícil subir|metabolismo rápido/.test(lowerMessage)) return 'muscleGain.hardgainer';
        return 'muscleGain.general';
      }
      
      // Patrones para recetas
      if (/receta|cocinar|preparar|comida|plato/.test(lowerMessage)) {
        if (/desayuno|mañana/.test(lowerMessage)) {
          if (/rápido|prisa|tiempo/.test(lowerMessage)) return 'recipes.breakfast.quick';
          return 'recipes.breakfast.hearty';
        }
        if (/almuerzo|comida|lunch/.test(lowerMessage)) {
          if (/oficina|trabajo|llevar/.test(lowerMessage)) return 'recipes.lunch.office';
          return 'recipes.lunch.home';
        }
        if (/cena|noche/.test(lowerMessage)) {
          if (/ligero|light|poco/.test(lowerMessage)) return 'recipes.dinner.light';
          return 'recipes.dinner.satisfying';
        }
        if (/snack|merienda|colación/.test(lowerMessage)) {
          if (/dulce|antojo|chocolate/.test(lowerMessage)) return 'recipes.snacks.sweet';
          return 'recipes.snacks.savory';
        }
      }
      
      // Otros temas específicos
      if (/horario|cuándo|timing|hora/.test(lowerMessage)) {
        if (/trabajo|oficina|turno/.test(lowerMessage)) return 'mealTiming.workSchedule';
        return 'mealTiming.general';
      }
      
      if (/lactosa|lácteo|leche/.test(lowerMessage)) return 'intolerances.lactose';
      if (/gluten|celíaco|trigo/.test(lowerMessage)) return 'intolerances.gluten';
      
      if (/agua|hidrat|beber|sed/.test(lowerMessage)) {
        if (/ejercicio|entreno|deporte/.test(lowerMessage)) return 'hydration.exercise';
        return 'hydration.general';
      }
      
      if (/ejercicio|entreno|gym|deporte/.test(lowerMessage)) return 'exercise';
      if (/gracias|bye|adiós|hasta luego/.test(lowerMessage)) return 'goodbye';
      
      return null;
    },
  
    // Función principal de categorización
    categorize: (message) => {
      const lowerMessage = message.toLowerCase();
      
      // Saludos
      if (/hola|buenos|buenas|hey|qué tal/.test(lowerMessage)) return 'greetings';
      
      // Detectar emoción primero
      const emotion = this.detectEmotion(message);
      if (emotion) return `emotional.${emotion}`;
      
      // Detectar tema específico
      const topic = this.detectTopic(message);
      if (topic) return topic;
      
      // Si no hay coincidencias claras, revisar si parece incoherente
      if (lowerMessage.length < 3 || /^[^a-záéíóúñ]*$/.test(lowerMessage) || 
          lowerMessage.split(' ').length < 2) {
        return 'fallback';
      }
      
      return 'general';
    }
  };
  
  // Función mejorada para obtener respuestas
  export const getIntelligentResponse = (message) => {
    const category = intelligentCategorizer.categorize(message);
    const parts = category.split('.');
    
    let responses = nutritionKnowledge;
    for (const part of parts) {
      responses = responses[part];
      if (!responses) break;
    }
    
    if (Array.isArray(responses)) {
      return responses[Math.floor(Math.random() * responses.length)];
    }
    
    // Si no encuentra respuesta específica, usa general
    return nutritionKnowledge.general[Math.floor(Math.random() * nutritionKnowledge.general.length)];
  };
  
  // Funciones de utilidad adicionales
  export const getMotivationalMessage = () => {
    return nutritionKnowledge.motivation[Math.floor(Math.random() * nutritionKnowledge.motivation.length)];
  };
  
  export const getRandomRecipe = (mealType = null) => {
    if (mealType && nutritionKnowledge.recipes[mealType]) {
      const mealRecipes = nutritionKnowledge.recipes[mealType];
      const subTypes = Object.keys(mealRecipes);
      const randomSubType = subTypes[Math.floor(Math.random() * subTypes.length)];
      const recipes = mealRecipes[randomSubType];
      return recipes[Math.floor(Math.random() * recipes.length)];
    }
    
    // Receta completamente aleatoria
    const mealTypes = Object.keys(nutritionKnowledge.recipes);
    const randomMealType = mealTypes[Math.floor(Math.random() * mealTypes.length)];
    return getRandomRecipe(randomMealType);
  };
  
  // Sistema de context awareness para conversaciones más naturales
  export const contextManager = {
    lastTopic: null,
    userProfile: {
      goals: [],
      restrictions: [],
      preferences: [],
      challenges: []
    },
    
    updateContext: (message, response) => {
      const category = intelligentCategorizer.categorize(message);
      contextManager.lastTopic = category;
      
      // Detectar información del usuario para personalizar futuras respuestas
      const lowerMessage = message.toLowerCase();
      
      // Detectar objetivos
      if (/perder peso|adelgazar/.test(lowerMessage)) {
        contextManager.userProfile.goals.push('weight_loss');
      }
      if (/ganar peso|masa muscular/.test(lowerMessage)) {
        contextManager.userProfile.goals.push('muscle_gain');
      }
      
      // Detectar restricciones
      if (/lactosa|sin lácteos/.test(lowerMessage)) {
        contextManager.userProfile.restrictions.push('lactose_free');
      }
      if (/gluten|celíaco/.test(lowerMessage)) {
        contextManager.userProfile.restrictions.push('gluten_free');
      }
      if (/vegetariano|sin carne/.test(lowerMessage)) {
        contextManager.userProfile.restrictions.push('vegetarian');
      }
      if (/vegano|sin animales/.test(lowerMessage)) {
        contextManager.userProfile.restrictions.push('vegan');
      }
      
      // Detectar desafíos
      if (/tiempo|prisa|rápido/.test(lowerMessage)) {
        contextManager.userProfile.challenges.push('time_constraints');
      }
      if (/trabajo|oficina/.test(lowerMessage)) {
        contextManager.userProfile.challenges.push('office_worker');
      }
    },
    
    getPersonalizedResponse: (message) => {
      const baseResponse = getIntelligentResponse(message);
      
      // Añadir personalización basada en el perfil del usuario
      let personalizedAddition = "";
      
      if (contextManager.userProfile.restrictions.includes('vegetarian')) {
        personalizedAddition += "\n\nPor cierto, recuerda que al ser vegetariano es importante que combines bien las proteínas vegetales.";
      }
      
      if (contextManager.userProfile.challenges.includes('time_constraints')) {
        personalizedAddition += "\n\nComo veo que andas con poco tiempo, te recomiendo meal prep los domingos para toda la semana.";
      }
      
      return baseResponse + personalizedAddition;
    }
  };
  
  // Respuestas adicionales para situaciones específicas
  export const specialSituations = {
    // Para cuando el usuario pregunta algo muy específico que no está cubierto
    specificFood: (food) => {
      return `Sobre ${food} específicamente, te puedo decir que es importante considerar su valor nutricional en el contexto de tu dieta completa. ¿Te gustaría que te ayude a incluirlo en un plan de comidas o tienes alguna duda específica sobre este alimento?`;
    },
    
    // Para cuando mencionan una marca específica
    brandQuestion: () => {
      return "En cuanto a marcas específicas, lo más importante es leer las etiquetas nutricionales y elegir productos con ingredientes simples y sin muchos aditivos. ¿Hay algún nutriente en particular que estés buscando en este producto?";
    },
    
    // Para preguntas médicas que no podemos responder
    medicalDisclaimer: () => {
      return "Esa es una excelente pregunta, pero toca temas médicos específicos que están fuera de mi alcance. Te recomiendo consultar con un nutricionista certificado o tu médico para obtener asesoría personalizada y segura. Mientras tanto, ¿hay algo sobre alimentación general en lo que sí te pueda ayudar?";
    },
    
    // Para cuando preguntan sobre suplementos específicos
    supplementAdvice: () => {
      return "Los suplementos pueden ser útiles en ciertas situaciones, pero siempre es mejor obtener nutrientes de alimentos integrales cuando sea posible. Para recomendaciones específicas de suplementos, te sugiero consultar con un profesional de la salud que pueda evaluar tus necesidades individuales. ¿Te gustaría que hablemos sobre alimentos ricos en los nutrientes que te interesan?";
    }
  };
  
  // Funciones de detección avanzada
  export const advancedDetection = {
    // Detecta si la pregunta es sobre un alimento específico
    isAboutSpecificFood: (message) => {
      const foodWords = /\b(pollo|pescado|arroz|pasta|quinoa|avena|huevos|yogur|frutas|verduras|carne|salmón|atún|brócoli|espinacas|plátano|manzana|aguacate|almendras)\b/i;
      return foodWords.test(message);
    },
    
    // Detecta si menciona una marca
    mentionsBrand: (message) => {
      // Patrones comunes de marcas o preguntas sobre marcas
      const brandPatterns = /\b(marca|producto|comprar|tienda|súper|supermercado)\b/i;
      return brandPatterns.test(message);
    },
    
    // Detecta preguntas médicas que no debemos responder
    isMedicalQuestion: (message) => {
      const medicalWords = /\b(enfermedad|diabetes|hipertensión|colesterol|medicamento|tratamiento|síndrome|condición médica|doctor|médico)\b/i;
      return medicalWords.test(message);
    },
    
    // Detecta preguntas sobre suplementos específicos
    isSupplementQuestion: (message) => {
      const supplementWords = /\b(suplemento|vitamina|mineral|pastilla|cápsula|proteína en polvo|creatina|omega)\b/i;
      return supplementWords.test(message);
    }
  };
  
  // Función principal mejorada que maneja todos los casos
  export const getSmartResponse = (message) => {
    // Actualizar contexto
    contextManager.updateContext(message, null);
    
    // Detecciones especiales
    if (advancedDetection.isMedicalQuestion(message)) {
      return specialSituations.medicalDisclaimer();
    }
    
    if (advancedDetection.isSupplementQuestion(message)) {
      return specialSituations.supplementAdvice();
    }
    
    if (advancedDetection.mentionsBrand(message)) {
      return specialSituations.brandQuestion();
    }
    
    if (advancedDetection.isAboutSpecificFood(message)) {
      const foodMatch = message.match(/\b(pollo|pescado|arroz|pasta|quinoa|avena|huevos|yogur|frutas|verduras|carne|salmón|atún|brócoli|espinacas|plátano|manzana|aguacate|almendras)\b/i);
      if (foodMatch) {
        return specialSituations.specificFood(foodMatch[0]);
      }
    }
    
    // Respuesta personalizada normal
    return contextManager.getPersonalizedResponse(message);
  };
  
  // Ejemplos de uso y testing
  export const testCases = {
    examples: [
      {
        input: "Hola, estoy frustrado porque no logro perder peso",
        expectedCategory: "emotional.frustrated",
        description: "Debería detectar frustración y redirigir a respuestas empáticas"
      },
      {
        input: "¿Qué puedo desayunar rápido antes del trabajo?",
        expectedCategory: "recipes.breakfast.quick",
        description: "Debería sugerir desayunos rápidos"
      },
      {
        input: "asdfgh",
        expectedCategory: "fallback",
        description: "Mensaje incoherente debería ir a fallback"
      },
      {
        input: "Tengo diabetes y no sé qué comer",
        expectedCategory: "medical",
        description: "Pregunta médica debería redirigir a profesional"
      }
    ],
    
    runTests: () => {
      console.log("🧪 Ejecutando tests del sistema de respuestas...\n");
      
      testCases.examples.forEach((test, index) => {
        const category = intelligentCategorizer.categorize(test.input);
        const response = getSmartResponse(test.input);
        
        console.log(`Test ${index + 1}: ${test.description}`);
        console.log(`Input: "${test.input}"`);
        console.log(`Categoría detectada: ${category}`);
        console.log(`Respuesta: ${response.substring(0, 100)}...`);
        console.log("---\n");
      });
    }
  };
  
  // Export de todas las funciones principales
  export default {
    getSmartResponse,
    getIntelligentResponse,
    getMotivationalMessage,
    getRandomRecipe,
    intelligentCategorizer,
    contextManager,
    testCases
  };